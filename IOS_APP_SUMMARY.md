# iOS/WatchOS Apps - Summary for Claude Code

**ะะฐัะฐ:** 2025-11-27  
**ะกัะฐััั:** โ ะะตัะฐะบัะพัะธะฝะณ ะทะฐะฒะตััะตะฝ, ะณะพัะพะฒะพ ะบ ะดะฐะปัะฝะตะนัะตะน ัะฐะฑะพัะต

**ะัะธะปะพะถะตะฝะธั:**
- iPhone App (iOS 17+) - ะัะฝะพะฒะฝะพะน ะธะฝัะตััะตะนั
- Apple Watch App (watchOS 10+) - ะะพะผะฟะฐะฝัะพะฝ ะฟัะธะปะพะถะตะฝะธะต

---

## ๐ฑ iOS App Architecture

### ะะฑัะฐั ััััะบัััะฐ

**ะััะธัะตะบัััะฝัะน ะฟะฐััะตัะฝ:** MVVM (Model-View-ViewModel)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    Views (SwiftUI)                        โ
โ  RecordingView | TerminalDetailView | UnifiedHeaderView  โ
โโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                       โ @EnvironmentObject
                       โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  ViewModels                              โ
โ  AgentViewModel | TerminalAgentViewModel | TerminalVM   โ
โโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                       โ Dependencies
                       โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    Services                              โ
โ  TTSService | SessionStateManager | AudioRecorder | ... โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐๏ธ ะัะฝะพะฒะฝัะต ะบะพะผะฟะพะฝะตะฝัั

### Services (ะกะตัะฒะธัั)

#### 1. **TTSService** (Unified TTS Service)
- **ะะฐะทะฝะฐัะตะฝะธะต:** ะะดะธะฝัะน ัะตัะฒะธั ะดะปั ะณะตะฝะตัะฐัะธะธ ะธ ะฒะพัะฟัะพะธะทะฒะตะดะตะฝะธั TTS
- **ะฃัััะฐะฝัะตั:** ~240 ัััะพะบ ะดัะฑะปะธัะพะฒะฐะฝะธั ะบะพะดะฐ
- **ะะปััะตะฒัะต ะผะตัะพะดั:**
  - `shouldGenerateTTS()` - ะฟัะพะฒะตัะบะฐ ะฝะตะพะฑัะพะดะธะผะพััะธ ะณะตะฝะตัะฐัะธะธ
  - `synthesizeAndPlay()` - ะณะตะฝะตัะฐัะธั ะธ ะฒะพัะฟัะพะธะทะฒะตะดะตะฝะธะต
  - `replay()` - ะฟะพะฒัะพั ะฟะพัะปะตะดะฝะตะณะพ ะฐัะดะธะพ
  - `reset()` - ัะฑัะพั ัะพััะพัะฝะธั

#### 2. **SessionStateManager** (State Management)
- **ะะฐะทะฝะฐัะตะฝะธะต:** ะะดะธะฝัะน ะธััะพัะฝะธะบ ะธััะธะฝั ะดะปั ัะตััะธะน ะธ ัะตะถะธะผะพะฒ ะฟัะพัะผะพััะฐ
- **ะัะพะฑะตะฝะฝะพััะธ:**
  - Singleton ะดะปั production (`SessionStateManager.shared`)
  - Test initializer ะดะปั DI (`init(testPrefix:)`)
  - ะะตััะธััะตะฝัะฝะพััั ัะตัะตะท UserDefaults
  - ะะพะดะดะตัะถะบะฐ ะธะทะพะปะธัะพะฒะฐะฝะฝะพะณะพ ัะพััะพัะฝะธั ะดะปั ะบะฐะถะดะพะณะพ ัะตัะผะธะฝะฐะปะฐ

#### 3. **AudioRecorder**
- **ะะฐะทะฝะฐัะตะฝะธะต:** ะะฐะฟะธัั ะณะพะปะพัะฐ ะธ STT ะพะฑัะฐะฑะพัะบะฐ
- **ะัะพะฑะตะฝะฝะพััะธ:**
  - `@Published var isRecording` - ะฐะฒัะพะผะฐัะธัะตัะบะพะต ะพะฑะฝะพะฒะปะตะฝะธะต ัะตัะตะท Combine
  - ะะฝัะตะณัะฐัะธั ั OpenAI Whisper API
  - ะะฒัะพะผะฐัะธัะตัะบะฐั ััะฐะฝัะบัะธะฟัะธั

#### 4. **AudioPlayer**
- **ะะฐะทะฝะฐัะตะฝะธะต:** ะะพัะฟัะพะธะทะฒะตะดะตะฝะธะต ะฐัะดะธะพ ะดะปั TTS
- **ะัะพะฑะตะฝะฝะพััะธ:**
  - ะะพะดะดะตัะถะบะฐ ัะพะฝะพะฒะพะณะพ ะฒะพัะฟัะพะธะทะฒะตะดะตะฝะธั
  - Fade out ะดะปั ะฟะปะฐะฒะฝะพะณะพ ะพะบะพะฝัะฐะฝะธั
  - Now Playing info ะดะปั Control Center

#### 5. **EventBus** (Type-Safe Events)
- **ะะฐะทะฝะฐัะตะฝะธะต:** ะฆะตะฝััะฐะปะธะทะพะฒะฐะฝะฝะฐั ัะธััะตะผะฐ ัะพะฑััะธะน ัะตัะตะท Combine
- **ะะฐะผะตะฝัะตั:** NotificationCenter (string-based)
- **ะัะตะธะผััะตััะฒะฐ:**
  - Type-safe ัะพะฑััะธั
  - ะัััะฐั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััั
  - ะัะพัะต ัะตััะธัะพะฒะฐัั

#### 6. **IdleTimerManager**
- **ะะฐะทะฝะฐัะตะฝะธะต:** ะัะตะดะพัะฒัะฐัะตะฝะธะต ะทะฐััะฟะฐะฝะธั ัะบัะฐะฝะฐ ะฒะพ ะฒัะตะผั ะฐะบัะธะฒะฝัั ะพะฟะตัะฐัะธะน
- **ะัะพะฑะตะฝะฝะพััะธ:**
  - ะะพะดะดะตัะถะบะฐ ะผะฝะพะถะตััะฒะตะฝะฝัั ะพะฟะตัะฐัะธะน
  - ะะฒัะพะผะฐัะธัะตัะบะพะต ัะฟัะฐะฒะปะตะฝะธะต ะถะธะทะฝะตะฝะฝัะผ ัะธะบะปะพะผ
  - Cleanup ะฟัะธ ะทะฐะฒะตััะตะฝะธะธ ะฟัะธะปะพะถะตะฝะธั

### ViewModels (ะะธะทะฝะตั-ะปะพะณะธะบะฐ)

#### 1. **AgentViewModel**
- **ะะฐะทะฝะฐัะตะฝะธะต:** ะะปะพะฑะฐะปัะฝัะน ะฐะณะตะฝั ะดะปั ะณะพะปะพัะพะฒัั ะบะพะผะฐะฝะด
- **ะัะพะฑะตะฝะฝะพััะธ:**
  - ะฃะฟัะฐะฒะปะตะฝะธะต ะทะฐะฟะธััั ะธ ััะฐะฝัะบัะธะฟัะธะตะน
  - ะัะฟะพะปะฝะตะฝะธะต ะบะพะผะฐะฝะด ัะตัะตะท API
  - ะะฑัะฐะฑะพัะบะฐ TTS ะพัะฒะตัะพะฒ
  - ะะตััะธััะตะฝัะฝะพััั ัะพััะพัะฝะธั

#### 2. **TerminalAgentViewModel**
- **ะะฐะทะฝะฐัะตะฝะธะต:** ะขะตัะผะธะฝะฐะปัะฝัะน ะฐะณะตะฝั ะดะปั ะณะพะปะพัะพะฒัั ะบะพะผะฐะฝะด
- **ะัะพะฑะตะฝะฝะพััะธ:**
  - ะะทะพะปะธัะพะฒะฐะฝะฝะพะต ัะพััะพัะฝะธะต ะดะปั ะบะฐะถะดะพะณะพ ัะตัะผะธะฝะฐะปะฐ
  - ะะตััะธััะตะฝัะฝะพััั ัะตัะตะท UserDefaults (per terminal)
  - ะะพะดะดะตัะถะบะฐ PTY ะธ Agent ัะตะถะธะผะพะฒ
  - ะะฝัะตะณัะฐัะธั ั RecordingStreamClient

#### 3. **TerminalViewModel**
- **ะะฐะทะฝะฐัะตะฝะธะต:** ะฃะฟัะฐะฒะปะตะฝะธะต ัะตัะผะธะฝะฐะปัะฝัะผะธ ัะตััะธัะผะธ
- **ะัะพะฑะตะฝะฝะพััะธ:**
  - ะกะฟะธัะพะบ ะฐะบัะธะฒะฝัั ัะตััะธะน
  - WebSocket ะฟะพะดะบะปััะตะฝะธั
  - ะฃะฟัะฐะฒะปะตะฝะธะต ะถะธะทะฝะตะฝะฝัะผ ัะธะบะปะพะผ ัะตััะธะน

### Views (UI)

#### 1. **RecordingView**
- **ะะฐะทะฝะฐัะตะฝะธะต:** ะะฝัะตััะตะนั ะณะปะพะฑะฐะปัะฝะพะณะพ ะฐะณะตะฝัะฐ
- **ะัะฟะพะปัะทัะตั:** `AgentViewModel`

#### 2. **TerminalDetailView**
- **ะะฐะทะฝะฐัะตะฝะธะต:** ะะตัะฐะปัะฝัะน ะฒะธะด ัะตัะผะธะฝะฐะปะฐ ั ะฟะตัะตะบะปััะตะฝะธะตะผ ัะตะถะธะผะพะฒ
- **ะะตะถะธะผั:** PTY (ัะตัะผะธะฝะฐะป) ะธ Agent (ะณะพะปะพัะพะฒัะต ะบะพะผะฐะฝะดั)
- **ะัะฟะพะปัะทัะตั:** `TerminalAgentViewModel`, `SessionStateManager`

#### 3. **UnifiedHeaderView**
- **ะะฐะทะฝะฐัะตะฝะธะต:** ะะฑัะธะน ะทะฐะณะพะปะพะฒะพะบ ะฟัะธะปะพะถะตะฝะธั
- **ะัะพะฑะตะฝะฝะพััะธ:** ะะฐะฒะธะณะฐัะธั, ะธะฝะดะธะบะฐัะพั ะฟะพะดะบะปััะตะฝะธั, ะฟะตัะตะบะปััะตะฝะธะต ัะตะถะธะผะพะฒ

---

## ๐งช Testing Infrastructure

### Dependency Injection ะดะปั ัะตััะพะฒ

**ะัะพะฑะปะตะผะฐ:** Singleton (`SessionStateManager.shared`) ัะพะทะดะฐะฒะฐะป ะฟัะพะฑะปะตะผั ั ะธะทะพะปััะธะตะน ัะตััะพะฒ

**ะะตัะตะฝะธะต:** Test initializer
```swift
// Production
let manager = SessionStateManager.shared

// Tests
let manager = SessionStateManager(testPrefix: "test_\(prefix)_")
```

**ะะตะทัะปััะฐัั:**
- โ ะะทะพะปะธัะพะฒะฐะฝะฝัะต ัะบะทะตะผะฟะปััั ะดะปั ะบะฐะถะดะพะณะพ ัะตััะฐ
- โ ะะตั ะฟัะพะฑะปะตะผ ั state pollution
- โ ะฃะฑัะฐะฝั ะฒัะต ะทะฐะดะตัะถะบะธ (59 ะฒัะทะพะฒะพะฒ `Task.sleep` ัะดะฐะปะตะฝะพ)
- โ ะฃัะบะพัะตะฝะธะต ะฝะฐ ~30%

### Test Coverage

**Unit Tests (44):**
- `TTSServiceTests`: 11 ัะตััะพะฒ
- `SessionStateManagerTests`: 20 ัะตััะพะฒ (ั DI)
- `AgentViewModelTests`: 8 ัะตััะพะฒ
- `TerminalAgentViewModelTests`: 5 ัะตััะพะฒ

**Integration Tests (5):**
- Recording Flow (2 ัะตััะฐ)
- Terminal Agent Flow (1 ัะตัั)
- View Mode Switching (2 ัะตััะฐ)

**ะะตะทัะปััะฐัั:**
- โ 54/56 ัะตััะพะฒ ะฟัะพัะพะดัั (96.4%)
- โ ะัะตะผั ะฒัะฟะพะปะฝะตะฝะธั: ~24-33 ัะตะบัะฝะดั
- โ ะฃะฑัะฐะฝั ะฑะตััะผััะปะตะฝะฝัะต ัะตััั (ะฟัะพะฒะตััะปะธ implementation details)

---

## ๐ State Management

### SessionStateManager

**Single Source of Truth:**
- `activeSessionId`: ะขะตะบััะฐั ะฐะบัะธะฒะฝะฐั ัะตััะธั
- `activeViewMode`: ะะตะถะธะผ ะฟัะพัะผะพััะฐ (PTY/Agent)
- `sessionModes`: ะะตะถะธะผั ะดะปั ะบะฐะถะดะพะน ัะตััะธะธ (ะฟะตััะธััะตะฝัะฝะพััั)
- `sessionNames`: ะะผะตะฝะฐ ัะตััะธะน

**ะะตััะธััะตะฝัะฝะพััั:**
- UserDefaults ะดะปั ัะพััะฐะฝะตะฝะธั ัะพััะพัะฝะธั
- ะะฒัะพะผะฐัะธัะตัะบะฐั ะทะฐะณััะทะบะฐ ะฟัะธ ะธะฝะธัะธะฐะปะธะทะฐัะธะธ
- ะะทะพะปะธัะพะฒะฐะฝะฝัะต ะบะปััะธ ะดะปั ัะตััะพะฒ

### Per-Terminal State

**TerminalAgentViewModel:**
- ะะทะพะปะธัะพะฒะฐะฝะฝะพะต ัะพััะพัะฝะธะต ะดะปั ะบะฐะถะดะพะณะพ ัะตัะผะธะฝะฐะปะฐ
- ะะตััะธััะตะฝัะฝะพััั ัะตัะตะท `terminal_state_{sessionId}`
- ะะฒัะพะผะฐัะธัะตัะบะฐั ะทะฐะณััะทะบะฐ ะฒ `init()`
- ะะฒัะพะผะฐัะธัะตัะบะพะต ัะพััะฐะฝะตะฝะธะต ะฟัะธ ะธะทะผะตะฝะตะฝะธัั

---

## ๐ฏ ะััะธัะตะบัััะฝัะต ะฟัะธะฝัะธะฟั

### 1. MVVM Pattern
- **Views:** ะขะพะปัะบะพ UI, ะฑะตะท ะฑะธะทะฝะตั-ะปะพะณะธะบะธ
- **ViewModels:** ะัั ะฑะธะทะฝะตั-ะปะพะณะธะบะฐ, `@ObservableObject`
- **Services:** ะะตัะตะธัะฟะพะปัะทัะตะผะฐั ััะฝะบัะธะพะฝะฐะปัะฝะพััั

### 2. Single Source of Truth
- `SessionStateManager` - ะดะปั ัะตััะธะน ะธ ัะตะถะธะผะพะฒ
- `EventBus` - ะดะปั ัะพะฑััะธะน (ะทะฐะผะตะฝัะตั NotificationCenter)
- ViewModels - ะดะปั ัะพััะพัะฝะธั ะบะฐะถะดะพะณะพ ัะบัะฐะฝะฐ

### 3. Dependency Injection
- Production: Singleton ะดะปั ัะดะพะฑััะฒะฐ
- Tests: DI ะดะปั ะธะทะพะปััะธะธ
- Test initializers ะดะปั ะฒัะตั ัะตััะธััะตะผัั ะบะพะผะฟะพะฝะตะฝัะพะฒ

### 4. Combine ะดะปั ัะตะฐะบัะธะฒะฝะพััะธ
- `@Published` ัะฒะพะนััะฒะฐ ะดะปั ะฐะฒัะพะผะฐัะธัะตัะบะธั ะพะฑะฝะพะฒะปะตะฝะธะน
- Binding ะฒะผะตััะพ ะฟััะผะพะณะพ ะฟัะธัะฒะฐะธะฒะฐะฝะธั
- Type-safe ัะพะฑััะธั ัะตัะตะท EventBus

### 5. Lifecycle Management
- `IdleTimerManager` ะดะปั ัะฟัะฐะฒะปะตะฝะธั ะทะฐััะฟะฐะฝะธะตะผ ัะบัะฐะฝะฐ
- Proper cleanup ะฒ `deinit`
- State persistence ะฟัะธ ะฟะตัะตัะพะดะฐั ะผะตะถะดั ัะบัะฐะฝะฐะผะธ

---

## ๐ ะะตััะธะบะธ ัะตัะฐะบัะพัะธะฝะณะฐ

### Code Reduction
- **-37%** ะพะฑัะตะต ัะพะบัะฐัะตะฝะธะต ะบะพะดะฐ
- **-240 ัััะพะบ** ะดัะฑะปะธัะพะฒะฐะฝะธั TTS ะปะพะณะธะบะธ
- **-40%** ะดัะฑะปะธัะพะฒะฐะฝะธั ะผะตะถะดั ViewModels

### Test Coverage
- **54 ัะตััะฐ** (44 Unit + 5 Integration + 5 additional)
- **96.4%** ะฟัะพัะพะดัั
- **~30%** ััะบะพัะตะฝะธะต ะฒัะฟะพะปะฝะตะฝะธั

### Architecture Quality
- โ MVVM ะฟะฐััะตัะฝ ัะพะฑะปัะดะตะฝ
- โ Single Source of Truth ัะตะฐะปะธะทะพะฒะฐะฝ
- โ Dependency Injection ะดะปั ัะตััะพะฒ
- โ ะะตั ะดัะฑะปะธัะพะฒะฐะฝะธั ะบะพะดะฐ
- โ ะงะตัะบะพะต ัะฐะทะดะตะปะตะฝะธะต ะพัะฒะตัััะฒะตะฝะฝะพััะธ

---

## ๐ ะะพัะพะฒะพ ะบ ัะฐะฑะพัะต

**ะกัะฐััั:** โ ะัะต 7 ัะฐะท ัะตัะฐะบัะพัะธะฝะณะฐ ะทะฐะฒะตััะตะฝั

**ะงัะพ ะณะพัะพะฒะพ:**
- โ ะััะธัะตะบัััะฐ ัะปัััะตะฝะฐ (MVVM, DI, Single Source of Truth)
- โ ะขะตััั ะฝะฐะฟะธัะฐะฝั ะธ ะฟัะพัะพะดัั (54/56)
- โ ะะพะบัะผะตะฝัะฐัะธั ะพะฑะฝะพะฒะปะตะฝะฐ
- โ ะะพะด ะณะพัะพะฒ ะบ ะดะฐะปัะฝะตะนัะตะน ัะฐะทัะฐะฑะพัะบะต

**ะกะปะตะดัััะธะต ัะฐะณะธ (ะพะฟัะธะพะฝะฐะปัะฝะพ):**
- Code Coverage verification
- Performance Tests
- SwiftLint setup

---

**ะะปั ัะฐะฑะพัั ั Apple ะฟัะธะปะพะถะตะฝะธัะผะธ ัะผ. ัะฐะบะถะต:**
- `APPLE_APPS_DOCUMENTATION.md` - ะฟะพะปะฝะฐั ะดะพะบัะผะตะฝัะฐัะธั ะฟะพ Apple ะฟัะธะปะพะถะตะฝะธัะผ
- `REFACTORING_PLAN.md` - ะดะตัะฐะปัะฝัะน ะฟะปะฐะฝ ัะตัะฐะบัะพัะธะฝะณะฐ
- `CLAUDE.md` - ัะตัะฝะธัะตัะบะฐั ัะฟะตัะธัะธะบะฐัะธั
- `IPHONE_APP_IMPROVEMENTS.md` - ะฝะตะดะฐะฒะฝะธะต ัะปัััะตะฝะธั (swipe-to-delete, portrait lock, scrolling)
- `.cursorrules` - ะฟัะฐะฒะธะปะฐ ัะฐะทัะฐะฑะพัะบะธ ะดะปั ะฐะณะตะฝัะพะฒ
